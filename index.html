<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhaps Catcher - Jogo de Coleta</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            padding: 20px;
        }

        canvas {
            border: 4px solid #22c55e;
            background: #000;
            border-radius: 8px;
            max-width: 100%;
            max-height: calc(100vh - 140px);
            aspect-ratio: 480/500;
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.3);
            transition: box-shadow 0.3s ease;
        }

        canvas:hover {
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.6);
        }

        .controls {
            display: flex;
            flex-wrap: nowrap;
            gap: 18px;
            margin-top: 25px;
            justify-content: center;
            align-items: center;
            padding: 18px 24px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(25, 35, 54, 0.5));
            border-radius: 22px;
            border: 1px solid rgba(16, 185, 129, 0.25);
            backdrop-filter: blur(25px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 0 30px rgba(16, 185, 129, 0.1);
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        button {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.23, 1, 0.320, 1);
            font-size: 16px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 52px;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: brightness(1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        button:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn-checkin {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 60%, #1d4ed8 100%);
            color: white;
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.45),
                0 0 60px rgba(59, 130, 246, 0.25),
                inset 0 1px 2px rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.6);
        }

        .btn-checkin:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 
                0 16px 48px rgba(59, 130, 246, 0.6),
                0 0 80px rgba(59, 130, 246, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border-color: rgba(59, 130, 246, 0.8);
            filter: brightness(1.15);
        }

        .btn-checkin:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.5),
                inset 0 2px 6px rgba(0, 0, 0, 0.2);
            animation: coinPing 0.4s ease;
        }

        .btn-checkin:disabled {
            opacity: 0.6;
            filter: grayscale(30%);
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .checkin-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .checkin-subtext {
            font-size: 10px;
            color: #FFD700;
            font-weight: 600;
            margin-top: 2px;
        }

        .btn-missions {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 60%, #dc2626 100%);
            color: white;
            box-shadow: 
                0 8px 32px rgba(249, 115, 22, 0.45),
                0 0 60px rgba(249, 115, 22, 0.25),
                inset 0 1px 2px rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(249, 115, 22, 0.6);
            height: 52px;
        }

        .btn-missions:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 
                0 16px 48px rgba(249, 115, 22, 0.6),
                0 0 80px rgba(249, 115, 22, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border-color: rgba(249, 115, 22, 0.8);
            filter: brightness(1.15);
        }

        .btn-missions:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px rgba(249, 115, 22, 0.5),
                inset 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-missions:disabled {
            opacity: 0.6;
            filter: grayscale(30%);
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .btn-leaderboard {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 60%, #7e22ce 100%);
            color: white;
            box-shadow: 
                0 8px 32px rgba(168, 85, 247, 0.45),
                0 0 60px rgba(168, 85, 247, 0.25),
                inset 0 1px 2px rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(168, 85, 247, 0.6);
            height: 52px;
        }

        .btn-leaderboard:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 
                0 16px 48px rgba(168, 85, 247, 0.6),
                0 0 80px rgba(168, 85, 247, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            border-color: rgba(168, 85, 247, 0.8);
            filter: brightness(1.15);
        }

        .btn-leaderboard:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 24px rgba(168, 85, 247, 0.5),
                inset 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-leaderboard:disabled {
            opacity: 0.6;
            filter: grayscale(30%);
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
        }

        .stats {
            background: linear-gradient(135deg, rgba(20, 83, 45, 0.3), rgba(12, 74, 110, 0.2));
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 13px;
            text-align: center;
            border: 1px solid rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation-delay: 0.1s;
        }

        @keyframes coinPing {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #000;
            border: 3px solid #10b981;
            border-radius: 28px;
            padding: 40px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 0 60px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.2);
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-leaderboard .modal-content {
            border-color: #a855f7;
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
        }

        .modal-header h2 {
            color: #10b981;
            font-size: 36px;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .modal-leaderboard .modal-header h2 {
            color: #a855f7;
        }

        .close-btn {
            background: none;
            border: none;
            color: #10b981;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #059669;
            transform: rotate(90deg);
        }

        .modal-leaderboard .close-btn {
            color: #a855f7;
        }

        .modal-leaderboard .close-btn:hover {
            color: #9333ea;
        }

        .points-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.4);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 24px;
            text-align: center;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .points-box p {
            color: #10b981;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .points-box .points {
            color: #10b981;
            font-size: 32px;
            font-weight: 900;
            font-family: 'Playfair Display', serif;
        }

        .mission-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.08));
            border: 2px solid rgba(16, 185, 129, 0.35);
            border-radius: 20px;
            padding: 22px;
            margin-bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(12px);
            -webkit-tap-highlight-color: transparent;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .mission-card:hover:not(.completed) {
            border-color: #10b981;
            box-shadow: 0 0 35px rgba(16, 185, 129, 0.45);
            transform: translateY(-3px);
        }

        .mission-card:active:not(.completed) {
            transform: translateY(-1px);
        }

        .mission-card.completed {
            background: linear-gradient(135deg, rgba(55, 65, 81, 0.2), rgba(55, 65, 81, 0.1));
            border-color: rgba(75, 85, 99, 0.4);
            opacity: 0.6;
        }

        .mission-icon {
            font-size: 36px;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }

        .mission-card:hover .mission-icon:not(.completed) {
            transform: scale(1.1) rotate(5deg);
        }

        .mission-info {
            flex: 1;
        }

        .mission-info h4 {
            color: #fff;
            margin-bottom: 6px;
            font-size: 9.56px;
            font-weight: 700;
        }

        .mission-info p {
            color: #e5e7eb;
            font-size: 7.88px;
            margin-bottom: 0;
        }

        .mission-points {
            color: #10b981;
            font-weight: 800;
            font-size: 14px;
            font-family: 'Playfair Display', serif;
        }

        .mission-btn {
            padding: 10px 28px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 800;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: auto;
            margin-top: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 
                0 8px 24px rgba(16, 185, 129, 0.4),
                0 0 20px rgba(16, 185, 129, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .mission-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            transition: left 0.6s ease;
        }

        .mission-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .mission-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .mission-btn:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 12px 40px rgba(16, 185, 129, 0.6),
                0 0 30px rgba(16, 185, 129, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.2);
        }

        .mission-btn:active:not(:disabled) {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.4),
                inset 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .mission-btn:disabled {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            cursor: not-allowed;
            opacity: 0.5;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            filter: grayscale(50%);
            transform: translateY(0);
        }

        /* LEADERBOARD STYLES */
        .leaderboard-row {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(147, 51, 234, 0.08));
            border: 2px solid rgba(168, 85, 247, 0.35);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .leaderboard-row:hover {
            border-color: #a855f7;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
            transform: translateX(5px);
        }

        .leaderboard-row.user-row {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
            border-color: #3b82f6;
        }

        .leaderboard-row.user-row:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }

        .rank-badge {
            font-size: 24px;
            font-weight: 900;
            min-width: 40px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }
        .rank-other { color: #a855f7; }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            color: #fff;
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .leaderboard-score {
            color: #a855f7;
            font-weight: 800;
            font-size: 18px;
            font-family: 'Playfair Display', serif;
        }

        .game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(15, 23, 42, 0.95));
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .game-over-modal.show {
            display: flex;
        }

        .game-over-content {
            text-align: center;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .game-over-title {
            font-family: 'Playfair Display', serif;
            font-size: 72px;
            color: #FF3333;
            margin-bottom: 30px;
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(255, 51, 51, 0.5);
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-over-score-value {
            font-size: 48px;
            color: #FFD700;
            font-weight: 800;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation-delay: 0.1s;
        }

        .game-over-cooldown {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 30px 50px;
            margin: 40px 0;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation-delay: 0.2s;
        }

        .cooldown-label {
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .cooldown-timer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 36px;
            color: #10b981;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .game-over-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 60%, #047857 100%);
            color: white;
            border: 2px solid rgba(16, 185, 129, 0.6);
            padding: 18px 60px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 
                0 8px 32px rgba(16, 185, 129, 0.4),
                0 0 60px rgba(16, 185, 129, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation-delay: 0.3s;
            position: relative;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-over-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            transition: left 0.5s ease;
        }

        .game-over-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .game-over-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 
                0 14px 48px rgba(16, 185, 129, 0.6),
                0 0 80px rgba(16, 185, 129, 0.35),
                inset 0 1px 2px rgba(255, 255, 255, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
            border-color: rgba(16, 185, 129, 0.8);
            filter: brightness(1.15);
        }

        .game-over-btn:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(16, 185, 129, 0.4),
                inset 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .game-over-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(30%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            transform: translateY(0);
        }

        /* PARTICLE EFFECTS */
        .particle {
            position: fixed;
            pointer-events: none;
            z-index: 50;
        }

        /* SOUND TOGGLE */
        .sound-toggle {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 60%, #1d4ed8 100%);
            border: 2px solid rgba(59, 130, 246, 0.6);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 6px 24px rgba(59, 130, 246, 0.4),
                0 0 48px rgba(59, 130, 246, 0.15),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 999;
        }

        .sound-toggle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .sound-toggle:hover {
            transform: translateY(-50%) scale(1.12);
            box-shadow: 
                0 10px 36px rgba(59, 130, 246, 0.6),
                0 0 60px rgba(59, 130, 246, 0.25),
                inset 0 1px 2px rgba(255, 255, 255, 0.4);
            filter: brightness(1.2);
        }

        .sound-toggle:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 
                0 4px 16px rgba(59, 130, 246, 0.3),
                inset 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .sound-toggle.muted {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 60%, #374151 100%);
            border-color: rgba(107, 114, 128, 0.6);
            box-shadow: 
                0 6px 24px rgba(107, 114, 128, 0.3),
                0 0 48px rgba(107, 114, 128, 0.1),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
            filter: grayscale(40%);
        }

        .sound-toggle.muted:hover {
            transform: translateY(-50%) scale(1.12);
            box-shadow: 
                0 10px 36px rgba(107, 114, 128, 0.4),
                0 0 60px rgba(107, 114, 128, 0.15),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
            filter: grayscale(20%);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            canvas {
                border: 3px solid #22c55e;
                max-height: calc(100vh - 120px);
            }

            button {
                font-size: 12px;
                padding: 12px 20px;
            }

            .controls {
                gap: 12px;
                padding: 16px 18px;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            .game-over-title {
                font-size: 48px;
            }

            .sound-toggle {
                width: 45px;
                height: 45px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            canvas {
                border: 2px solid #22c55e;
            }

            .controls {
                gap: 10px;
                flex-wrap: wrap;
                padding: 12px 14px;
            }

            .stats {
                flex: 1 1 100%;
                margin-top: 8px;
            }

            button {
                font-size: 11px;
                padding: 10px 16px;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="position: relative; display: inline-block;">
            <canvas id="gameCanvas" width="480" height="500"></canvas>
            <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 18px; font-weight: bold; color: #10b981;">RHAPS CATCHER</div>
            
            <!-- Cooldown Timer Display -->
            <div id="cooldownDisplay" style="
                position: absolute;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(16, 185, 129, 0.1));
                border: 2px solid rgba(16, 185, 129, 0.6);
                border-radius: 14px;
                padding: 12px 24px;
                text-align: center;
                font-size: 12px;
                color: #10b981;
                font-weight: 700;
                font-family: 'Poppins', sans-serif;
                backdrop-filter: blur(10px);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
                pointer-events: none;
                display: none;
                z-index: 10;
                white-space: nowrap;
            ">
                <div style="font-size: 10px; margin-bottom: 4px; color: rgba(16, 185, 129, 0.8);">‚è±Ô∏è PR√ìXIMO JOGO EM:</div>
                <div id="cooldownDisplayTimer" style="font-size: 16px; font-weight: 900; font-family: 'JetBrains Mono', monospace; letter-spacing: 1px;">8h 0m 0s</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="checkin-container">
                <button class="btn-checkin" id="checkinBtn">üìÖ Check-in (+15)</button>
                <span class="checkin-subtext" id="checkinSubtext" style="display: none;">Volte amanh√£</span>
            </div>
            <button class="btn-missions" id="missionsBtn">üéØ Miss√µes</button>
            <button class="btn-leaderboard" id="leaderboardBtn">üèÜ Ranking</button>
            <div class="stats">
                <p>üèÜ <span id="bestScore">0</span> &nbsp; üí∞ <span id="totalPoints">0</span></p>
                <p>üìà Total: <span id="totalScore">0</span></p>
                <p id="userInfo">üë§ Jogador</p>
            </div>
        </div>
    </div>

    <!-- Modal Miss√µes -->
    <div class="modal" id="missionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéØ Miss√µes</h2>
                <button class="close-btn" onclick="closeMissionsModal()">‚úï</button>
            </div>
            
            <div class="points-box">
                <p>üí∞ PONTOS CONQUISTADOS</p>
                <div class="points" id="missionPoints">0</div>
            </div>

            <div id="missionsList"></div>
        </div>
    </div>

    <!-- Modal Ranking -->
    <div class="modal modal-leaderboard" id="leaderboardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèÜ Ranking</h2>
                <button class="close-btn" onclick="closeLeaderboardModal()">‚úï</button>
            </div>
            <div id="leaderboardList"></div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h1 class="game-over-title">GAME OVER</h1>
            
            <div style="font-size: 28px; margin-bottom: 40px;">
                Pontua√ß√£o Final: <span class="game-over-score-value" id="gameOverScore">0</span>
            </div>

            <div class="game-over-cooldown">
                <div class="cooldown-label">‚è±Ô∏è Volte em:</div>
                <div class="cooldown-timer" id="cooldownTimer">8h 0m 0s</div>
            </div>

            <button class="game-over-btn" id="gameOverBtn" onclick="restartGame()">Jogar Novamente</button>

            <div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid rgba(16, 185, 129, 0.3);">
                <p id="returnCountdown" style="font-size: 16px; color: #a0aec0;">Voltando √† tela inicial em 10s...</p>
            </div>
        </div>
    </div>

    <!-- Sound Toggle -->
    <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

    <script>
        // ============ AUDIO MANAGER ============
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = localStorage.getItem('rhapsSoundEnabled') !== 'false';

        class SoundManager {
            constructor(ctx) {
                this.ctx = ctx;
                this.isEnabled = soundEnabled;
            }

            playSound(type) {
                if (!this.isEnabled) return;
                switch(type) {
                    case 'coin': this.playCoinSound(); break;
                    case 'lose-life': this.loseLiveSound(); break;
                    case 'game-over': this.gameOverSound(); break;
                    case 'checkin': this.checkInSound(); break;
                }
            }

            playCoinSound() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + 0.1);
            }

            loseLiveSound() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(200, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + 0.3);
            }

            gameOverSound() {
                const notes = [330, 280, 250];
                let delay = 0;
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        if (!this.isEnabled) return;
                        const osc = this.ctx.createOscillator();
                        const gain = this.ctx.createGain();
                        osc.connect(gain);
                        gain.connect(this.ctx.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                        osc.start(this.ctx.currentTime);
                        osc.stop(this.ctx.currentTime + 0.2);
                    }, delay);
                    delay += 150;
                });
            }

            checkInSound() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.frequency.setValueAtTime(600, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(900, this.ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.25, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + 0.15);
            }

            setEnabled(enabled) {
                this.isEnabled = enabled;
                localStorage.setItem('rhapsSoundEnabled', enabled);
            }
        }

        const soundManager = new SoundManager(audioContext);

        function toggleSound() {
            soundManager.setEnabled(!soundManager.isEnabled);
            const toggle = document.getElementById('soundToggle');
            if (soundManager.isEnabled) {
                toggle.classList.remove('muted');
                toggle.textContent = 'üîä';
            } else {
                toggle.classList.add('muted');
                toggle.textContent = 'üîá';
            }
        }

        // ============ PARTICLE EFFECTS ============
        class Particle {
            constructor(x, y, vx, vy, life, emoji) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.life = life;
                this.maxLife = life;
                this.emoji = emoji;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.15;
                this.life--;
            }

            draw(ctx) {
                ctx.globalAlpha = this.life / this.maxLife;
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.emoji, this.x, this.y);
                ctx.globalAlpha = 1;
            }

            isAlive() {
                return this.life > 0;
            }
        }

        let particles = [];

        function createParticles(x, y, count = 5) {
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 * i) / count;
                const speed = 3;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed - 2;
                particles.push(new Particle(x + 15, y + 15, vx, vy, 40, '‚ú®'));
            }
        }

        // ============ VARI√ÅVEIS GLOBAIS ============
        let gameVars = {
            player: { x: 220, y: 430, width: 40, height: 50 },
            coins: [],
            speed: 2.0,
            gameRunning: false
        };

        let gameState = {
            score: 0,
            bestScore: localStorage.getItem('rhapsBestScore') ? parseInt(localStorage.getItem('rhapsBestScore')) : 0,
            totalScore: localStorage.getItem('rhapsTotalScore') ? parseInt(localStorage.getItem('rhapsTotalScore')) : 0,
            lives: 3,
            missedCoins: 0,
            isPaused: false,
            missionRewards: localStorage.getItem('rhapsMissionRewards') ? parseInt(localStorage.getItem('rhapsMissionRewards')) : 0,
            completedMissions: localStorage.getItem('rhapsCompletedMissions') ? JSON.parse(localStorage.getItem('rhapsCompletedMissions')) : {},
            canCheckIn: true,
            playerName: localStorage.getItem('rhapsPlayerName') || `Jogador_${Math.floor(Math.random() * 10000)}`
        };

        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');

        const missions = [
            { id: 'twitter-follow', title: 'Seguir Rhapsody (X)', description: 'Siga nosso perfil no Twitter/X', icon: 'ùïè', points: 100, url: 'https://x.com/Rhapsodycoin', isDaily: false },
            { id: 'twitter-like', title: 'Curtir Novo Post (X)', description: 'Curta nosso √∫ltimo post', icon: '‚ù§Ô∏è', points: 50, url: 'https://x.com/Rhapsodycoin', isDaily: true },
            { id: 'instagram-follow', title: 'Seguir Instagram', description: 'Siga nosso perfil no Instagram', icon: 'üì∑', points: 100, url: 'https://www.instagram.com/rhapsodycoin/', isDaily: false },
            { id: 'instagram-like', title: 'Curtir Novo Post (IG)', description: 'Curta nosso √∫ltimo post no Instagram', icon: 'üíï', points: 50, url: 'https://www.instagram.com/rhapsodycoin/', isDaily: true },
            { id: 'linkedin-follow', title: 'Seguir LinkedIn', description: 'Siga nosso perfil no LinkedIn', icon: 'üíº', points: 100, url: 'https://www.linkedin.com/company/rhapsody-coin/', isDaily: false },
            { id: 'linkedin-like', title: 'Curtir Novo Post (LinkedIn)', description: 'Curta nosso √∫ltimo post no LinkedIn', icon: 'üëç', points: 50, url: 'https://www.linkedin.com/company/rhapsody-coin/', isDaily: true },
            { id: 'musicplayce-download', title: 'Baixar App Musicplayce', description: 'Baixe o App Musicplayce para ganhar mais Rhaps', icon: 'üéµ', points: 200, url: 'https://musicplayce.com/', isDaily: false },
        ];

        // ============ LEADERBOARD ============
        function saveScoreToLeaderboard(name, score) {
            let leaderboard = localStorage.getItem('rhapsLeaderboard') ? JSON.parse(localStorage.getItem('rhapsLeaderboard')) : [];
            leaderboard.push({ name, score, totalScore: gameState.totalScore, date: new Date().toLocaleDateString() });
            leaderboard.sort((a, b) => b.totalScore - a.totalScore);
            leaderboard = leaderboard.slice(0, 20);
            localStorage.setItem('rhapsLeaderboard', JSON.stringify(leaderboard));
        }

       async function renderLeaderboard() {
    let leaderboard = [];
    
    // Tentar buscar do Firebase (GLOBAL)
    try {
        leaderboard = await fetchLeaderboardFromServer();
        console.log('üìä Ranking Global do Firebase carregado');
    } catch (error) {
        console.warn('‚ö†Ô∏è Usando ranking local:', error);
        leaderboard = localStorage.getItem('rhapsLeaderboard') 
            ? JSON.parse(localStorage.getItem('rhapsLeaderboard')) 
            : [];
    }
    
    const list = document.getElementById('leaderboardList');

    if (leaderboard.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 40px 20px;">Nenhuma pontua√ß√£o registrada. Jogue e aparece aqui!</p>';
        return;
    }

    // Migrar dados antigos
    leaderboard = leaderboard.map(entry => ({
        ...entry,
        totalScore: entry.totalScore || entry.score
    }));

    // Ordenar por totalScore
    leaderboard.sort((a, b) => b.totalScore - a.totalScore);

    console.log('üèÜ Leaderboard renderizado:', leaderboard);

    list.innerHTML = leaderboard.map((entry, idx) => {
        const rank = idx + 1;
        const isCurrentUser = entry.playerName === gameState.playerName;
        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
        const totalScore = entry.totalScore || entry.score || 0;

        return `
            <div class="leaderboard-row ${isCurrentUser ? 'user-row' : ''}">
                <div class="rank-badge ${rankClass}">${medal}</div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${entry.playerName} ${isCurrentUser ? '(Voc√™)' : ''}</div>
                    <div style="font-size: 12px; color: #a0aec0;">üìà ${totalScore} pontos | ${entry.date || 'N/A'}</div>
                </div>
                <div class="leaderboard-score">${entry.score || 0}</div>
            </div>
        `;
    }).join('');
}

        // ============ COOLDOWN DISPLAY ============
        let cooldownDisplayInterval = null;

        function showCooldownDisplay() {
            document.getElementById('cooldownDisplay').style.display = 'block';
            updateCooldownDisplay();
        }

        function hideCooldownDisplay() {
            document.getElementById('cooldownDisplay').style.display = 'none';
            if (cooldownDisplayInterval) {
                clearInterval(cooldownDisplayInterval);
            }
        }

        function updateCooldownDisplay() {
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            if (!lastGameOverTime) {
                hideCooldownDisplay();
                return;
            }

            const cooldownMs = 8 * 60 * 60 * 1000;
            const nextPlayTime = lastGameOverTime + cooldownMs;

            if (cooldownDisplayInterval) clearInterval(cooldownDisplayInterval);

            const updateDisplay = () => {
                const remainingMs = nextPlayTime - Date.now();
                if (remainingMs <= 0) {
                    hideCooldownDisplay();
                    return;
                }

                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

                document.getElementById('cooldownDisplayTimer').textContent = `${hours}h ${minutes}m ${seconds}s`;
            };

            updateDisplay();
            cooldownDisplayInterval = setInterval(updateDisplay, 1000);
        }

        // ============ TELEGRAM WEB APP ============
        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();

                const user = tg.initDataUnsafe.user;
                if (user) {
                    const telegramUsername = user.username || `User_${user.id}`;
                    gameState.playerName = `@${telegramUsername}`;
                    localStorage.setItem('rhapsPlayerName', gameState.playerName);
                    
                    // Atualiza a UI com o nome do Telegram
                    document.getElementById('userInfo').textContent = `üë§ ${gameState.playerName}`;
                }
            }
        }

        // ============ ATUALIZA√á√ÉO DO COUNTDOWN DAS MISS√ïES ============
        let missionUpdateInterval = null;

        function startMissionCountdownUpdate() {
            if (missionUpdateInterval) clearInterval(missionUpdateInterval);
            
            missionUpdateInterval = setInterval(() => {
                const modal = document.getElementById('missionsModal');
                if (modal && modal.classList.contains('show')) {
                    renderMissions();
                }
            }, 60000); // Atualiza a cada 1 minuto
        }

        // ============ INICIALIZA√á√ÉO ============
        window.addEventListener('load', () => {
            // Inicializa Telegram Web App
            initTelegram();

            const toggle = document.getElementById('soundToggle');
            if (!soundEnabled) {
                toggle.classList.add('muted');
                toggle.textContent = 'üîá';
            }
            renderMissions();
            await renderLeaderboard();
            startGame();
            updateUI();
            startMissionCountdownUpdate();
            
            // Mostra cooldown se necess√°rio
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            if (lastGameOverTime) {
                const now = Date.now();
                const cooldownMs = 8 * 60 * 60 * 1000;
                if (now < lastGameOverTime + cooldownMs) {
                    showCooldownDisplay();
                }
            }
        });

        // ============ JOGO ============
        function startGame() {
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            if (lastGameOverTime) {
                const now = Date.now();
                const cooldownMs = 8 * 60 * 60 * 1000;
                if (now < lastGameOverTime + cooldownMs) {
                    // Cooldown ainda ativo - mostra a tela de cooldown
                    gameVars.gameRunning = false;
                    showCooldownDisplay();
                    showGameOverScreenWithCooldown();
                    return;
                } else {
                    // Cooldown expirou - limpa o localStorage
                    localStorage.removeItem('rhapsLastGameOver');
                }
            }

            gameState.score = 0;
            gameState.lives = 3;
            gameState.missedCoins = 0;
            gameState.isPaused = false;
            gameVars.coins = [];
            gameVars.speed = 1.2;
            gameVars.gameRunning = true;
            gameLoop();
        }

        function gameLoop() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Update particles
            particles = particles.filter(p => p.isAlive());
            particles.forEach(p => {
                p.update();
                p.draw(ctx);
            });

            if (!gameState.isPaused && gameVars.gameRunning) {
                if (!gameVars.lastCoinTime) gameVars.lastCoinTime = Date.now();
                
                if (Date.now() - gameVars.lastCoinTime > 2016 / gameVars.speed) {
                    gameVars.coins.push({
                        id: Math.random(),
                        x: Math.random() * 420,
                        y: 0,
                        width: 30,
                        height: 30,
                        speed: 2 * gameVars.speed
                    });
                    gameVars.lastCoinTime = Date.now();
                }

                gameVars.coins = gameVars.coins.filter(coin => {
                    coin.y += coin.speed;

                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(coin.x + 15, coin.y + 15, 15, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('R', coin.x + 15, coin.y + 15);

                    // Colis√£o
                    if (coin.x < gameVars.player.x + gameVars.player.width &&
                        coin.x + coin.width > gameVars.player.x &&
                        coin.y < gameVars.player.y + gameVars.player.height &&
                        coin.y + coin.height > gameVars.player.y) {
                        gameState.score++;
                        gameVars.speed += 0.0324;
                        gameState.missedCoins = 0;
                        soundManager.playSound('coin');
                        createParticles(coin.x, coin.y, 6);
                        updateUI();
                        return false;
                    }

                    // Caiu da tela
                    if (coin.y > 500) {
                        gameState.missedCoins++;
                        
                        if (gameState.missedCoins >= 3) {
                            gameState.lives--;
                            gameState.missedCoins = 0;
                            updateUI();
                            soundManager.playSound('lose-life');
                            
                            if (gameState.lives <= 0) {
                                gameVars.gameRunning = false;
                                gameState.isPaused = true;
                                if (gameState.score > gameState.bestScore) {
                                    gameState.bestScore = gameState.score;
                                    localStorage.setItem('rhapsBestScore', gameState.bestScore);
                                }
                                // Somar score atual ao total cumulativo
                                gameState.totalScore += gameState.score;
                                localStorage.setItem('rhapsTotalScore', gameState.totalScore);
                                // Salva no servidor (se dispon√≠vel) e no localStorage (fallback)
                                saveScoreToServer(gameState.playerName, gameState.score).catch(() => {
                                    saveScoreToLeaderboard(gameState.playerName, gameState.score);
                                });
                                await renderLeaderboard();
                                setTimeout(() => {
                                    soundManager.playSound('game-over');
                                    showGameOverScreen();
                                }, 500);
                            } else {
                                gameState.isPaused = true;
                                showLoseLifePopup(gameState.lives);
                            }
                        }
                        return false;
                    }

                    return true;
                });
            }

            drawChick();
            drawUI();

            if (gameVars.gameRunning) {
                requestAnimationFrame(gameLoop);
            }
        }

        function drawChick() {
            const x = gameVars.player.x;
            const y = gameVars.player.y;

            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.ellipse(x + 17, y + 26, 15.3, 18.7, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.beginPath();
            ctx.arc(x + 17, y + 10, 10.2, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(x + 13, y + 7, 3.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 21, y + 8, 3.5, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x + 13.5, y + 7.5, 2, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#FF8C00';
            ctx.beginPath();
            ctx.moveTo(x + 25.5, y + 11);
            ctx.lineTo(x + 32, y + 11);
            ctx.lineTo(x + 27, y + 14);
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = '#FF8C00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + 14, y + 43);
            ctx.lineTo(x + 12, y + 50);
            ctx.stroke();
        }

        function drawUI() {
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Pontos: ${gameState.score}`, 20, 30);
            
            ctx.fillStyle = '#FF3333';
            ctx.font = 'bold 22px Arial';
            ctx.fillText(`‚ù§Ô∏è Vidas: ${gameState.lives}`, 20, 60);

            ctx.fillStyle = '#00FF00';
            ctx.font = 'bold 18px Arial';
            ctx.fillText(`‚ö° ${gameVars.speed.toFixed(2)}x`, 20, 90);
        }

        // ============ CONTROLES ============
        document.addEventListener('mousemove', (e) => {
            if (!gameVars.gameRunning || gameState.isPaused) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            gameVars.player.x = Math.max(0, Math.min(440, mouseX - gameVars.player.width / 2));
        });

        document.addEventListener('touchmove', (e) => {
            if (!gameVars.gameRunning || gameState.isPaused) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touchX = e.touches[0].clientX - rect.left;
            gameVars.player.x = Math.max(0, Math.min(440, touchX - gameVars.player.width / 2));
        }, { passive: false });

        // ============ CHECK-IN ============
        document.getElementById('checkinBtn').addEventListener('click', async () => {

            if (!gameState.canCheckIn) return;
            gameState.missionRewards += 15;
            gameState.totalScore += 15;
            gameState.canCheckIn = false;
            localStorage.setItem('rhapsMissionRewards', gameState.missionRewards);
            localStorage.setItem('rhapsTotalScore', gameState.totalScore);
            soundManager.playSound('checkin');
            updateUI();
        });

        // ============ MISS√ïES ============
        document.getElementById('missionsBtn').addEventListener('click', async () => {

            gameState.isPaused = true;
            gameVars.gameRunning = false;
            document.getElementById('missionsModal').classList.add('show');
        });

        document.getElementById('leaderboardBtn').addEventListener('click', async () => {  // ‚Üê Adicionar 'async'
        gameState.isPaused = true;
        gameVars.gameRunning = false;
        await renderLeaderboard();
        document.getElementById('leaderboardModal').classList.add('show');
        });

        function closeMissionsModal() {
            document.getElementById('missionsModal').classList.remove('show');
            if (gameState.lives > 0) {
                gameState.isPaused = false;
                gameVars.gameRunning = true;
                hideCooldownDisplay();
                gameLoop();
            }
        }

        function closeLeaderboardModal() {
            document.getElementById('leaderboardModal').classList.remove('show');
            if (gameState.lives > 0) {
                gameState.isPaused = false;
                gameVars.gameRunning = true;
                hideCooldownDisplay();
                gameLoop();
            }
        }

        // ============ TOUCH SUPPORT ============
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            const modal = document.getElementById('missionsModal');
            if (modal && modal.classList.contains('show')) {
                touchStartY = e.touches[0].clientY;
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const modal = document.getElementById('missionsModal');
            if (modal && modal.classList.contains('show')) {
                const touchEndY = e.changedTouches[0].clientY;
                if (touchStartY - touchEndY < -50) {
                    closeMissionsModal();
                }
            }
        }, { passive: true });

        function isMissionCompleted(missionId) {
            const completed = gameState.completedMissions[missionId];
            if (!completed) return false;

            const mission = missions.find(m => m.id === missionId);
            if (!mission.isDaily) return true;

            const completedDate = new Date(completed).toLocaleDateString();
            const today = new Date().toLocaleDateString();
            return completedDate === today;
        }

        function getTimeUntilNextPost(missionId) {
            const completed = gameState.completedMissions[missionId];
            if (!completed) return null;

            const completedTime = new Date(completed).getTime();
            const nextPostTime = completedTime + (24 * 60 * 60 * 1000);
            const now = Date.now();

            if (now >= nextPostTime) return null;

            const remainingMs = nextPostTime - now;
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));

            return `${hours}h ${minutes}m`;
        }

        function completeMission(missionId) {
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;

            const wasCompleted = isMissionCompleted(missionId);
            if (!wasCompleted) {
                gameState.missionRewards += mission.points;
                gameState.totalScore += mission.points;
                localStorage.setItem('rhapsMissionRewards', gameState.missionRewards);
                localStorage.setItem('rhapsTotalScore', gameState.totalScore);
            }

            gameState.completedMissions[missionId] = new Date().toISOString();
            localStorage.setItem('rhapsCompletedMissions', JSON.stringify(gameState.completedMissions));
            
            renderMissions();
            updateUI();
        }

        function renderMissions() {
            const list = document.getElementById('missionsList');
            list.innerHTML = missions.map(mission => {
                const isCompleted = isMissionCompleted(mission.id);
                let buttonText = 'Completar';
                let buttonDisabled = false;

                if (isCompleted) {
                    if (mission.isDaily) {
                        const timeUntil = getTimeUntilNextPost(mission.id);
                        buttonText = `‚è≥ Novo post em ${timeUntil}`;
                        buttonDisabled = true;
                    } else {
                        buttonText = '‚úì Conclu√≠da';
                        buttonDisabled = true;
                    }
                }

                return `
                    <div class="mission-card ${isCompleted ? 'completed' : ''}">
                        <div style="display: flex; gap: 12px;">
                            <div class="mission-icon">${mission.icon}</div>
                            <div>
                                <h4>${mission.title}</h4>
                                <p>${mission.description}</p>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="mission-points">üèÜ +${mission.points}</span>
                            <button class="mission-btn" onclick="completeMissionAndOpen('${mission.id}', '${mission.url}')" ${buttonDisabled ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('missionPoints').textContent = gameState.missionRewards;
        }

        function completeMissionAndOpen(missionId, url) {
            completeMission(missionId);
            window.open(url, '_blank');
        }

        // ============ POPUPS ============
        let loseLifeTimeout = null;

        function showLoseLifePopup(livesLeft) {
            let popupDiv = document.getElementById('loseLifePopup');
            if (!popupDiv) {
                popupDiv = document.createElement('div');
                popupDiv.id = 'loseLifePopup';
                popupDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 999;
                `;
                document.body.appendChild(popupDiv);
            }

            popupDiv.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
                    border: 3px solid #10b981;
                    border-radius: 20px;
                    padding: 30px 40px;
                    min-width: 350px;
                    text-align: center;
                    animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
                    box-shadow: 0 0 40px rgba(16, 185, 129, 0.4);
                ">
                    <div style="font-size: 60px; margin-bottom: 15px;">‚ù§Ô∏è</div>
                    <h2 style="font-family: 'Playfair Display', serif; font-size: 36px; color: #FF3333; margin-bottom: 15px; font-weight: 800;">Perdeu Uma Vida!</h2>
                    <p style="font-family: 'Poppins', sans-serif; font-size: 18px; color: #ffffff; margin-bottom: 25px;">
                        Vidas: <span style="color: #10b981; font-weight: 700; font-size: 28px;">${livesLeft}</span>
                    </p>
                    <button onclick="closeLoseLifePopup()" style="
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        border: 2px solid #10b981;
                        padding: 12px 40px;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">Continuar</button>
                </div>
            `;

            popupDiv.style.display = 'flex';

            if (loseLifeTimeout) clearTimeout(loseLifeTimeout);
            loseLifeTimeout = setTimeout(closeLoseLifePopup, 5000);
        }

        function closeLoseLifePopup() {
            const popupDiv = document.getElementById('loseLifePopup');
            if (popupDiv) popupDiv.style.display = 'none';
            gameState.isPaused = false;
        }

        // ============ GAME OVER ============
        let cooldownInterval = null;

        function showGameOverScreen() {
            const now = Date.now();
            localStorage.setItem('rhapsLastGameOver', now);
            
            document.getElementById('gameOverScore').textContent = gameState.score;
            document.getElementById('gameOverModal').classList.add('show');
            document.getElementById('gameOverBtn').disabled = true;
            
            showCooldownDisplay();
            startCooldownTimer();
            startAutoReturnCountdown();
        }

        function showGameOverScreenWithCooldown() {
            // Mostra tela de Game Over bloqueada sem pontua√ß√£o
            document.getElementById('gameOverModal').classList.add('show');
            document.getElementById('gameOverBtn').disabled = true;
            startCooldownTimer();
            startAutoReturnCountdown();
        }

        function startCooldownTimer() {
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            const cooldownMs = 8 * 60 * 60 * 1000;
            const nextPlayTime = lastGameOverTime + cooldownMs;

            const updateTimer = () => {
                const remainingMs = nextPlayTime - Date.now();
                if (remainingMs <= 0) {
                    clearInterval(cooldownInterval);
                    document.getElementById('cooldownTimer').textContent = '‚úÖ Pronto!';
                    document.getElementById('gameOverBtn').disabled = false;
                    return;
                }

                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

                document.getElementById('cooldownTimer').textContent = `${hours}h ${minutes}m ${seconds}s`;
            };

            updateTimer();
            cooldownInterval = setInterval(updateTimer, 1000);
        }

        function startAutoReturnCountdown() {
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            const cooldownMs = 8 * 60 * 60 * 1000;
            const isCooldownActive = lastGameOverTime && Date.now() < lastGameOverTime + cooldownMs;
            
            let returnTime = 10;
            const updateReturn = () => {
                if (isCooldownActive) {
                    // Se est√° em cooldown, mostra mensagem com countdown
                    document.getElementById('returnCountdown').innerHTML = `üîí <strong>Jogo bloqueado por 8 horas</strong><br><br>Voltando em ${returnTime}s...`;
                } else {
                    // Sem cooldown, mostra countdown normal
                    document.getElementById('returnCountdown').textContent = `Voltando em ${returnTime}s...`;
                }
                
                if (returnTime <= 0) {
                    document.getElementById('gameOverModal').classList.remove('show');
                    if (!isCooldownActive) {
                        startGame();
                    }
                } else {
                    returnTime--;
                }
            };
            updateReturn();
            setInterval(updateReturn, 1000);
        }

        function restartGame() {
            const lastGameOverTime = parseInt(localStorage.getItem('rhapsLastGameOver'));
            const cooldownMs = 8 * 60 * 60 * 1000;
            
            if (lastGameOverTime && Date.now() < lastGameOverTime + cooldownMs) {
                // Cooldown ainda ativo - n√£o deixa jogar
                return;
            }
            
            // Limpa o cooldown do localStorage
            localStorage.removeItem('rhapsLastGameOver');
            document.getElementById('gameOverModal').classList.remove('show');
            hideCooldownDisplay();
            startGame();
        }

        // ============ UI ============
        function updateUI() {
            document.getElementById('bestScore').textContent = gameState.bestScore;
            document.getElementById('totalPoints').textContent = gameState.missionRewards;
            document.getElementById('totalScore').textContent = gameState.totalScore;
            document.getElementById('checkinBtn').textContent = gameState.canCheckIn ? 'üìÖ Check-in (+15)' : '‚úì Feito';
            document.getElementById('checkinBtn').disabled = !gameState.canCheckIn;
            
            // Mostra/esconde o subtexto "Volte amanh√£"
            const checkinSubtext = document.getElementById('checkinSubtext');
            if (gameState.canCheckIn) {
                checkinSubtext.style.display = 'none';
            } else {
                checkinSubtext.style.display = 'block';
            }
        }

        window.addEventListener('click', (e) => {
            const missionsModal = document.getElementById('missionsModal');
            const leaderboardModal = document.getElementById('leaderboardModal');
            if (e.target === missionsModal) closeMissionsModal();
            if (e.target === leaderboardModal) closeLeaderboardModal();
        });

     // ============ FIREBASE INTEGRATION ============

const firebaseConfig = {
  apiKey: "AIzaSyCEGnQk-KloV77z-_hsn6oReKHcPmbwmD0",
  authDomain: "rhaps-catcher.firebaseapp.com",
  databaseURL: "https://rhaps-catcher-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rhaps-catcher",
  storageBucket: "rhaps-catcher.firebasestorage.app",
  messagingSenderId: "295712036594",
  appId: "1:295712036594:web:66aa123ea109397a78226b"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const scoresRef = database.ref('scores');

// Salvar score no Firebase (GLOBAL)
async function saveScoreToServer(playerName, score) {
    try {
        const scoreEntry = {
            playerName: playerName,
            score: parseInt(score),
            totalScore: gameState.totalScore,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            date: new Date().toLocaleDateString('pt-BR')
        };
        
        // Salva com um ID √∫nico
        await scoresRef.child(playerName + '_' + Date.now()).set(scoreEntry);
        console.log('‚úÖ Score salvo no Firebase!');
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao salvar:', error);
        saveScoreToLeaderboard(playerName, score);
        return false;
    }
}

// Buscar leaderboard GLOBAL do Firebase
async function fetchLeaderboardFromServer() {
    return new Promise((resolve) => {
        scoresRef.orderByChild('totalScore').limitToLast(100).once('value', (snapshot) => {
            const data = snapshot.val();
            
            if (!data) {
                resolve([]);
                return;
            }
            
            const leaderboard = Object.values(data)
                .sort((a, b) => b.totalScore - a.totalScore)
                .slice(0, 100);
            
            resolve(leaderboard);
        });
    });

    </script>
</body>
</html>
